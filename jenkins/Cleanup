def commonVars



pipeline {
    agent {
        node {
            label 'iacdipl-7'
            customWorkspace "workspace/${env.JOB_NAME}"
        }
    }
    stages {
        stage('Clean Workspace Before Checkout') {
            steps {
                deleteDir()
                checkout scm
                script {
                    commonVars = load 'jenkins/common/variables.groovy'
                }
            }
        }
        stage('Cleanup HTTPS-Server') {
            steps {
                sh """
                python3 scripts/cleanup_data_server.py --path ${commonVars.publicDataPath} --threshold 7 --exclude ${commonVars.publicDataPath}/file_index
                """
            }
        }
        stage('Delete All Non-Running Containers') {
            steps {
                sh """
                podman container prune -f
                """
            }
        }
        stage('Delete All Unused Images') {
            steps {
                sh """
                podman image prune -f
                """
            }
        }
        stage('Delete All Unused Layers') {
            steps {
                sh """
                podman system prune -f
                """
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}
