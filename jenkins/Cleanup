def https_public_root = '/net/co2/c2sm-services/zonda-request/'

pipeline {
    agent {
        node {
            label 'co2'
        }
    }
    stages {
        stage('Cleanup HTTPS-server') {
            steps {
                sh """
                python3 src/cleanup.py --path ${https_public_root} --threshold 7 --exclude ${https_public_root}/file_index
                """
            }
        }
    }
    stages {
        stage('Delete all non-running containers') {
            steps {
                sh """
                podman rm $(podman ps -a -q) 
                """
            }
        }
    }
    stages {
        stage('Delete all unused images') {
            steps {
                sh """
                podman rmi $(podman images -q --filter "dangling=true")
                """
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}
