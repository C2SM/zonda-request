def commonSteps



pipeline {
    agent none
    options {
        skipDefaultCheckout()
        timeout(time: 3, unit: 'HOURS')
    }
    parameters {
        booleanParam(name: 'DEBUG_MODE', defaultValue: false, description: 'Toggle debug mode on to always retain the workspace at the end of the pipeline.')
    }
    stages {
        stage('Matrix') {
            matrix {
                axes {
                    axis {
                        name 'ISSUE_ID'
                        values '195', '196', '197', '564', '565'
                    }
                }
                agent {
                    node {
                        label 'iacdipl-7'
                        customWorkspace "workspace/${env.JOB_NAME}/${env.ghprbPullId ?: ''}/${ISSUE_ID}"
                    }
                }
                stages {
                    stage('Clean Workspace Before Checkout') {
                        steps {
                            deleteDir()
                            script {
                                def scm_vars = checkout scm
                                env.GIT_COMMIT = scm_vars.GIT_COMMIT
                                commonSteps = load 'jenkins/common/steps.groovy'
                            }
                        }
                    }
                    stage('Setup Conda Environment') {
                        steps {
                            script {
                                commonSteps.setupCondaEnv()
                            }
                        }
                    }
                    stage('Create Hash from Current Time') {
                        steps {
                            script {
                                commonSteps.createHash()
                            }
                        }
                    }
                    stage('Create Config File') {
                        steps {
                            script {
                                commonSteps.createConfig()
                            }
                        }
                    }
                    stage('Process Request') {
                        steps {
                            script {
                                commonSteps.processRequest()
                            }
                        }
                    }
                }
                post {
                    success {
                        script {
                            commonSteps.archiveAndReport('success', env.GIT_COMMIT, env.BUILD_URL)
                        }
                    }
                    failure {
                        script {
                            commonSteps.archiveAndReport('failure', env.GIT_COMMIT, env.BUILD_URL)
                        }
                    }
                    aborted {
                        script {
                            commonSteps.archiveAndReport('aborted', env.GIT_COMMIT, env.BUILD_URL)
                        }
                    }
                    cleanup {
                        script {
                            if (!params.DEBUG_MODE) {
                                deleteDir()
                            }
                        }
                    }
                }
            }
        }
    }
}
